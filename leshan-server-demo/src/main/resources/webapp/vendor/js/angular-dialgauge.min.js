angular.module("angular-dialgauge",["ngSanitize"]).directive("ngDialGauge",["$window","$sce","$interval",function(a,e,t){return{restrict:"E",scope:{ngModel:"=",scaleMin:"@",scaleMax:"@",rotate:"@",angle:"@",value:"@",units:"@",title:"@",dialWidth:"@",borderWidth:"@",borderOffset:"@",borderColor:"@",trackColor:"@",barColor:"@",barColorEnd:"@",barWidth:"@",barAngle:"@",scaleOffset:"@",lineCap:"@",scaleMinorColor:"@",scaleMinorWidth:"@",scaleMinorLength:"@",scaleMinorSteps:"@",scaleMajorColor:"@",scaleMajorWidth:"@",scaleMajorLength:"@",scaleMajorSteps:"@",percent:"@",options:"=?"},template:'<div style="width:100%;height:100%;" ng-bind-html="gauge"></div>',controller:["$scope","$element",function(a,r){var o,l=180/Math.PI,n="",i=0,s=0,c=0,h=0,M=0,d=0,g=null,u=null,f=null,b=null,p=!1,C="",v={scaleMin:0,scaleMax:100,rotate:180,angle:225,units:"",title:"",dialWidth:3,borderWidth:1,borderOffset:2,borderColor:"#a0a0a0",trackColor:"#c0c0c0",barColor:"red",barColorEnd:"",barWidth:3,barAngle:0,scaleOffset:3,lineCap:"round",scaleMinorColor:"#c0c0c0",scaleMinorWidth:.5,scaleMinorLength:3,scaleMinorSteps:36,scaleMajorColor:"#c0c0c0",scaleMajorWidth:1,scaleMajorLength:5,scaleMajorSteps:9,percent:!1},W={};P({});var w=r[0].getBoundingClientRect(),x=Math.floor(Math.min(w.width,w.height)/2);function I(a){if(null==u)return u=a,void k(a);null!=b&&(t.cancel(b),b=null),f=u,u=a,b=t(function(){var a=(u-f)/10;Math.abs(a)<g?(f=u,t.cancel(b)):f+=a,k(f)},20,100)}function j(){if(!(x<=0)){var a=x-W.dialWidth,e=W.rotate-90;e<0&&(e+=360),e+=(360-W.angle)/2,(c=e/l)>2*Math.PI&&(c-=2*Math.PI),(h=c+W.angle/l)>2*Math.PI&&(h-=2*Math.PI),s=W.scaleMax/(W.scaleMax-W.scaleMin)*W.angle/l;var t="";0!=W.borderWidth&&(a-=Math.ceil(W.borderWidth/2),t+='<circle cx="'+x+'" cy="'+x+'" r="'+a+'" style="stroke:'+W.borderColor+";stroke-width:"+W.borderWidth+';fill:transparent;"/>',a-=Math.ceil(W.borderWidth/2),a-=W.borderOffset);var r=0;if(0==W.scaleMinorLength&&0==W.scaleMajorLength||(r=Math.max(W.scaleMajorLength,W.scaleMinorLength)),0!=W.scaleMinorLength){t+='<path d="';var o=c,n=(f=a-r)+W.scaleMinorLength,M=W.scaleMinorSteps,d=W.angle/M/l;do{var g=Math.cos(o),u=Math.sin(o);t+=" M"+(x+g*f)+" "+(x+u*f),t+=" L"+(x+g*n)+" "+(x+u*n),(o+=d)>2*Math.PI&&(o-=2*Math.PI)}while(M-- >0);t+='" ',t+='stroke="'+W.scaleMinorColor+'" stroke-width="'+W.scaleMinorWidth+'" />'}if(0!=W.scaleMajorLength){t+='<path d="';var f;o=c,n=(f=a-r)+W.scaleMajorLength,M=W.scaleMajorSteps,d=W.angle/M/l;do{g=Math.cos(o),u=Math.sin(o);t+=" M"+(x+g*f)+" "+(x+u*f),t+=" L"+(x+g*n)+" "+(x+u*n),(o+=d)>2*Math.PI&&(o-=2*Math.PI)}while(M-- >0);t+='" ',t+='stroke="'+W.scaleMajorColor+'" stroke-width="'+W.scaleMajorWidth+'" />'}if(0!==r&&(a-=r,a-=W.scaleOffset),a-=W.barWidth/2,i=a,"none"!=W.trackColor){var b=m(a,c+1e-7,h-1e-7);t+='<path d="M'+b.sX+" "+b.sY,t+=" A "+a+" "+a+",0,"+b.dir+",1,"+b.eX+" "+b.eY+'" ',t+='stroke="'+W.trackColor+'" stroke-linecap="'+W.lineCap+'" stroke-width="'+W.barWidth+'" fill="transparent"/>'}return W.title&&(t+='<text text-anchor="middle" x="'+x+'" y="'+(x+20)+'" class="dialgauge-title">'+W.title+"</text>"),t}}function k(t){var r,o,l,h=t;if(void 0===t?h=W.scaleMin:h>W.scaleMax?h=W.scaleMax:h<W.scaleMin&&(h=W.scaleMin),h=(h-W.scaleMin)/W.scaleMax,h*=s,0!==W.barAngle?((r=h-M)<0&&(r=0),(o=r+2*M)>d&&(r=(o=d)-2*M),(r+=c)>2*Math.PI&&(r-=2*Math.PI),o+=c):(r=c,o=h+c),o>2*Math.PI&&(o-=2*Math.PI),"string"==typeof W.barColor)l=W.barColor;else{for(var g=L(W.barColor[0]),u=L(W.barColor[1]),f=[],b=0;b<3;b++)f[b]=g[b]+(u[b]-g[b])*t/W.scaleMax;l=function(a){for(var e="#",t=0;t<3;t++){var r=Math.round(a[t]).toString(16);1==r.length&&(r="0"+r),e+=r}return e.toUpperCase()}(f)}var p=m(i,r,o),v="";v+='<path d="M'+p.sX+" "+p.sY,v+=" A "+i+" "+i+",0,"+p.dir+",1,"+p.eX+" "+p.eY+'" ',v+='stroke="'+l+'" stroke-linecap="'+W.lineCap+'" stroke-width="'+W.barWidth+'" fill="transparent"/>',void 0!==t&&(v+='<text text-anchor="middle" x="'+x+'" y="'+x+'"><tspan class="dialgauge-value">'+Math.floor(t)+"</tspan>"),null!=W.units&&(v+='<tspan dx="3" class="dialgauge-unit">'+W.units+"</tspan>"),v+="</text>",a.gauge=e.trustAsHtml('<svg width="100%" height="100%"><g '+C+">"+n+v+"</g></svg>")}function m(a,e,t){var r=x+Math.cos(e)*a,o=x+Math.sin(e)*a,l=x+Math.cos(t)*a,n=x+Math.sin(t)*a,i=0;return e>t&&2*Math.PI-e+t>Math.PI?i=1:t-e<Math.PI?i=0:e+t>Math.PI&&(i=1),{sX:r,sY:o,eX:l,eY:n,dir:i}}function P(a){if(null!=a){for(var e in v)void 0!==a[e]?W[e]=a[e]:void 0===W[e]&&(W[e]=v[e]),"number"==typeof v[e]?(W[e]=Number(W[e]),isNaN(W[e])&&(W[e]=0)):"boolean"==typeof v[e]&&"boolean"!=typeof W[e]&&(W[e]="true"===W[e]);if(0!==W.barColorEnd.length){var t=[];t[0]=W.barColor,t[1]=W.barColorEnd,W.barColor=t}p=W.percent,M=W.barAngle/l/2,d=W.angle/l,g=(W.scaleMax-W.scaleMin)/2e3}}function L(a){var e=parseInt(a.substr(1,2),16),t=parseInt(a.substr(3,2),16),r=parseInt(a.substr(5,2),16);return new Array(e,t,r)}o=2*x,a.getElementDimensions=function(){var a=r[0].getBoundingClientRect();return{h:a.height,w:a.width}},a.$watch(a.getElementDimensions,function(a,e){if(null!=a){var t=Math.floor(Math.min(a.w,a.h)/2);t!=x&&(o=2*(x=t),p&&(x=50,C='transform="scale('+o/100+')"'),n=j(),k(u))}},!0),a.$watch("options",function(){P(a.options),n=j(),k(u)}),a.$watch(["rotate","angle","scaleMin","scaleMax","lineCap","barWidth","barColor","barColorEnd","barAngle","trackColor","scaleOffset","scaleMinorSteps","scaleMajorColor","scaleMajorWidth","scaleMajorLength","scaleMajorSteps","scaleMinorLength","scaleMinorWidth","scaleMinorColor","dialWidth","borderWidth","borderOffset","borderColor","units","percent","title"],function(){P(a),n=j(),k(u)}),a.$watch("ngModel",function(a){I(a)}),a.$watch("value",function(){I(parseInt(a.value))})}]}}]);