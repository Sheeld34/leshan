angular.module("angular-dialgauge",["ngSanitize"]).directive("ngDialGauge",["$window","$sce","$interval",function(a,e,t){return{restrict:"E",scope:{ngModel:"=",scaleMin:"@",scaleMax:"@",rotate:"@",angle:"@",value:"@",units:"@",title:"@",dialWidth:"@",borderWidth:"@",borderOffset:"@",borderColor:"@",trackColor:"@",barColor:"@",barColorEnd:"@",barWidth:"@",barAngle:"@",scaleOffset:"@",lineCap:"@",scaleMinorColor:"@",scaleMinorWidth:"@",scaleMinorLength:"@",scaleMinorSteps:"@",scaleMajorColor:"@",scaleMajorWidth:"@",scaleMajorLength:"@",scaleMajorSteps:"@",percent:"@",options:"=?"},template:'<div style="width:100%;height:100%;" ng-bind-html="gauge"></div>',controller:["$scope","$element",function(a,r){var o,l=180/Math.PI,n="",i=0,s=0,c=0,h=0,M=0,d=0,u=null,g=null,f=null,b=null,p=!1,C="",v=0,W={scaleMin:0,scaleMax:100,rotate:180,angle:225,units:"",title:"",dialWidth:3,borderWidth:1,borderOffset:2,borderColor:"#a0a0a0",trackColor:"#c0c0c0",barColor:"red",barColorEnd:"",barWidth:3,barAngle:0,scaleOffset:3,lineCap:"round",scaleMinorColor:"#c0c0c0",scaleMinorWidth:.5,scaleMinorLength:3,scaleMinorSteps:36,scaleMajorColor:"#c0c0c0",scaleMajorWidth:1,scaleMajorLength:5,scaleMajorSteps:9,percent:!1},x={};L({});var w=r[0].getBoundingClientRect(),I=Math.floor(Math.min(w.width,w.height)/2);function j(a){if(null==g)return g=a,void m(a);null!=b&&(t.cancel(b),b=null),f=g,g=a,b=t(function(){var a=(g-f)/10;Math.abs(a)<u?(f=g,t.cancel(b)):f+=a,m(f)},20,100)}function k(){if(!(I<=0)){var a=I-x.dialWidth,e=x.rotate-90;e<0&&(e+=360),e+=(360-x.angle)/2,(c=e/l)>2*Math.PI&&(c-=2*Math.PI),(h=c+x.angle/l)>2*Math.PI&&(h-=2*Math.PI),s=x.scaleMax/(x.scaleMax-x.scaleMin)*x.angle/l;var t="";0!=x.borderWidth&&(a-=Math.ceil(x.borderWidth/2),t+='<circle cx="'+I+'" cy="'+I+'" r="'+a+'" style="stroke:'+x.borderColor+";stroke-width:"+x.borderWidth+';fill:transparent;"/>',a-=Math.ceil(x.borderWidth/2),a-=x.borderOffset);var r=0;if(0==x.scaleMinorLength&&0==x.scaleMajorLength||(r=Math.max(x.scaleMajorLength,x.scaleMinorLength)),0!=x.scaleMinorLength){t+='<path d="';var o=c,n=(f=a-r)+x.scaleMinorLength,M=x.scaleMinorSteps,d=x.angle/M/l;do{var u=Math.cos(o),g=Math.sin(o);t+=" M"+(I+u*f)+" "+(I+g*f),t+=" L"+(I+u*n)+" "+(I+g*n),(o+=d)>2*Math.PI&&(o-=2*Math.PI)}while(M-- >0);t+='" ',t+='stroke="'+x.scaleMinorColor+'" stroke-width="'+x.scaleMinorWidth+'" />'}if(0!=x.scaleMajorLength){t+='<path d="';var f;o=c,n=(f=a-r)+x.scaleMajorLength,M=x.scaleMajorSteps,d=x.angle/M/l;do{u=Math.cos(o),g=Math.sin(o);t+=" M"+(I+u*f)+" "+(I+g*f),t+=" L"+(I+u*n)+" "+(I+g*n),(o+=d)>2*Math.PI&&(o-=2*Math.PI)}while(M-- >0);t+='" ',t+='stroke="'+x.scaleMajorColor+'" stroke-width="'+x.scaleMajorWidth+'" />'}if(0!==r&&(a-=r,a-=x.scaleOffset),a-=x.barWidth/2,i=a,"none"!=x.trackColor){var b=P(a,c+1e-7,h-1e-7);t+='<path d="M'+b.sX+" "+b.sY,t+=" A "+a+" "+a+",0,"+b.dir+",1,"+b.eX+" "+b.eY+'" ',t+='stroke="'+x.trackColor+'" stroke-linecap="'+x.lineCap+'" stroke-width="'+x.barWidth+'" fill="transparent"/>'}return x.title&&(t+='<text text-anchor="middle" x="'+I+'" y="'+(I+20)+'" class="dialgauge-title">'+x.title+"</text>"),t}}function m(t){var r,o,l,h=t;if(void 0===t?h=x.scaleMin:h>x.scaleMax?h=x.scaleMax:h<x.scaleMin&&(h=x.scaleMin),h=(h-x.scaleMin)/x.scaleMax,h*=s,0!==x.barAngle?((r=h-M)<0&&(r=0),(o=r+2*M)>d&&(r=(o=d)-2*M),(r+=c)>2*Math.PI&&(r-=2*Math.PI),o+=c):(r=c,o=h+c),o>2*Math.PI&&(o-=2*Math.PI),"string"==typeof x.barColor)l=x.barColor;else{for(var u=y(x.barColor[0]),g=y(x.barColor[1]),f=[],b=0;b<3;b++)f[b]=u[b]+(g[b]-u[b])*t/x.scaleMax;l=function(a){for(var e="#",t=0;t<3;t++){var r=Math.round(a[t]).toString(16);1==r.length&&(r="0"+r),e+=r}return e.toUpperCase()}(f)}var p=P(i,r,o),W="";W+='<path d="M'+p.sX+" "+p.sY,W+=" A "+i+" "+i+",0,"+p.dir+",1,"+p.eX+" "+p.eY+'" ',W+='stroke="'+l+'" stroke-linecap="'+x.lineCap+'" stroke-width="'+x.barWidth+'" fill="transparent"/>',null!=t&&(W+='<text text-anchor="middle" x="'+I+'" y="'+I+'"><tspan class="dialgauge-value">'+t.toFixed(v)+"</tspan>"),null!=x.units&&(W+='<tspan dx="3" class="dialgauge-unit">'+x.units+"</tspan>"),W+="</text>",a.gauge=e.trustAsHtml('<svg width="100%" height="100%"><g '+C+">"+n+W+"</g></svg>")}function P(a,e,t){var r=I+Math.cos(e)*a,o=I+Math.sin(e)*a,l=I+Math.cos(t)*a,n=I+Math.sin(t)*a,i=0;return e>t&&2*Math.PI-e+t>Math.PI?i=1:t-e<Math.PI?i=0:e+t>Math.PI&&(i=1),{sX:r,sY:o,eX:l,eY:n,dir:i}}function L(a){if(null!=a){for(var e in W)void 0!==a[e]?x[e]=a[e]:void 0===x[e]&&(x[e]=W[e]),"number"==typeof W[e]?(x[e]=Number(x[e]),isNaN(x[e])&&(x[e]=0)):"boolean"==typeof W[e]&&"boolean"!=typeof x[e]&&(x[e]="true"===x[e]);if(0!==x.barColorEnd.length){var t=[];t[0]=x.barColor,t[1]=x.barColorEnd,x.barColor=t}p=x.percent,M=x.barAngle/l/2,d=x.angle/l,u=(x.scaleMax-x.scaleMin)/2e3}}function y(a){var e=parseInt(a.substr(1,2),16),t=parseInt(a.substr(3,2),16),r=parseInt(a.substr(5,2),16);return new Array(e,t,r)}o=2*I,a.getElementDimensions=function(){var a=r[0].getBoundingClientRect();return{h:a.height,w:a.width}},a.$watch(a.getElementDimensions,function(a,e){if(null!=a){var t=Math.floor(Math.min(a.w,a.h)/2);t!=I&&(o=2*(I=t),p&&(I=50,C='transform="scale('+o/100+')"'),n=k(),m(g))}},!0),a.$watch("options",function(){L(a.options),n=k(),m(g)}),a.$watch(["rotate","angle","scaleMin","scaleMax","lineCap","barWidth","barColor","barColorEnd","barAngle","trackColor","scaleOffset","scaleMinorSteps","scaleMajorColor","scaleMajorWidth","scaleMajorLength","scaleMajorSteps","scaleMinorLength","scaleMinorWidth","scaleMinorColor","dialWidth","borderWidth","borderOffset","borderColor","units","percent","title"],function(){L(a),n=k(),m(g)}),a.$watch("ngModel",function(a){j(a)}),a.$watch("value",function(){var e=parseFloat(a.value);v=function(a){if(!isFinite(a))return 0;var e=1,t=0;for(;Math.round(a*e)/e!==a;)e*=10,t++;return t}(e),j(e)})}]}}]);